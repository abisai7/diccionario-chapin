---
import { getLangFromUrl } from "../utils/i18n";

const lang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;

// Remove current language prefix to get base path
const basePath = currentPath.replace(/^\/(es|en)/, "") || "/";

// Generate opposite language URL
const targetLang = lang === "es" ? "en" : "es";
const targetPath = `/${targetLang}${basePath}`;
---

<a
  href={targetPath}
  class="language-switcher border-theme bg-card text-theme hover:bg-card-hover hover:border-primary-light inline-flex items-center gap-2 rounded-lg border px-3 py-2 text-sm font-medium transition-all"
  aria-label={lang === "es" ? "Switch to English" : "Cambiar a Español"}
>
  <svg
    width="18"
    height="18"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <circle cx="12" cy="12" r="10"></circle>
    <path
      d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
    ></path>
    <path d="M2 12h20"></path>
  </svg>
  <span class="language-switcher-text">{lang === "es" ? "EN" : "ES"}</span>
</a>

<script>
  function updateLanguageSwitchers() {
    const switchers = document.querySelectorAll(".language-switcher");
    const texts = document.querySelectorAll(".language-switcher-text");

    if (switchers.length === 0) return;

    const currentPath = window.location.pathname;
    const currentLang = currentPath.startsWith("/en") ? "en" : "es";
    const targetLang = currentLang === "es" ? "en" : "es";
    const basePath = currentPath.replace(/^\/(es|en)/, "") || "/";
    const targetPath = `/${targetLang}${basePath}`;

    switchers.forEach((switcher) => {
      switcher.setAttribute("href", targetPath);
      switcher.setAttribute(
        "aria-label",
        currentLang === "es" ? "Switch to English" : "Cambiar a Español"
      );
    });

    texts.forEach((text) => {
      text.textContent = currentLang === "es" ? "EN" : "ES";
    });
  }

  // Update on initial load
  updateLanguageSwitchers();

  // Update after each page navigation
  document.addEventListener("astro:page-load", updateLanguageSwitchers);
</script>
