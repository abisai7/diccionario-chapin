---
interface Props {
  isMobile?: boolean;
}

const { isMobile = false } = Astro.props;
const buttonId = isMobile ? "theme-toggle-mobile" : "theme-toggle";
const moonId = isMobile ? "moon-mobile" : "moon";
const sunId = isMobile ? "sun-mobile" : "sun";
const device = isMobile ? "mobile" : "desktop";
---

<button
  id={buttonId}
  class="theme-toggle-btn inline-flex cursor-pointer items-center gap-2 px-2.5 py-2"
  type="button"
  aria-label="Cambiar tema"
  data-umami-event="Theme Toggle"
  data-umami-event-device={device}
>
  <svg id={moonId} class="block" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"
    ><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79Z"></path></svg
  >
  <svg
    id={sunId}
    class="hidden"
    width="18"
    height="18"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    ><circle cx="12" cy="12" r="4"></circle><path
      d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"
    ></path></svg
  >
</button>

<script is:inline>
  const el = document.documentElement;
  const saved = localStorage.getItem("theme") || "dark";
  el.setAttribute("data-theme", saved);

  function setupThemeToggle() {
    // Botones de tema
    const btn = document.getElementById("theme-toggle");
    const btnMobile = document.getElementById("theme-toggle-mobile");
    const m = document.getElementById("moon");
    const s = document.getElementById("sun");
    const mMobile = document.getElementById("moon-mobile");
    const sMobile = document.getElementById("sun-mobile");

    function updateIcons() {
      const t = el.getAttribute("data-theme");
      if (t === "light") {
        s?.classList.remove("hidden");
        m?.classList.add("hidden");
        sMobile?.classList.remove("hidden");
        mMobile?.classList.add("hidden");
      } else {
        s?.classList.add("hidden");
        m?.classList.remove("hidden");
        sMobile?.classList.add("hidden");
        mMobile?.classList.remove("hidden");
      }
    }

    updateIcons();

    function toggleTheme() {
      const next = el.getAttribute("data-theme") === "dark" ? "light" : "dark";
      el.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
      updateIcons();
    }

    // Remove old listeners by cloning nodes
    if (btn) {
      const newBtn = btn.cloneNode(true);
      btn.parentNode?.replaceChild(newBtn, btn);
      document.getElementById("theme-toggle")?.addEventListener("click", toggleTheme);
    }

    if (btnMobile) {
      const newBtnMobile = btnMobile.cloneNode(true);
      btnMobile.parentNode?.replaceChild(newBtnMobile, btnMobile);
      document.getElementById("theme-toggle-mobile")?.addEventListener("click", toggleTheme);
    }
  }

  // Setup on initial load
  setupThemeToggle();

  // Re-setup after each page navigation
  document.addEventListener("astro:page-load", setupThemeToggle);

  // Mantener el tema durante las transiciones
  document.addEventListener("astro:after-swap", () => {
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.documentElement.setAttribute("data-theme", savedTheme);
  });
</script>
