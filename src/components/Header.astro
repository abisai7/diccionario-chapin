---
import { getLangFromUrl, useTranslations } from "../utils/i18n";
import LanguageSwitcher from "./LanguageSwitcher.astro";

const { title = "Diccionario Chapín" } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const prefix = lang === "en" ? "/en" : "/es";
---

<header class="mx-auto max-w-[1100px] px-4 py-4 sm:px-6" transition:persist>
  <div class="flex items-center justify-between gap-4">
    <!-- Logo y título -->
    <a
      href={`${prefix}/`}
      class="flex shrink-0 items-center gap-2 text-base font-bold sm:gap-2.5 sm:text-lg"
    >
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        aria-hidden="true"
        class="sm:h-[26px] sm:w-[26px]"
      >
        <circle
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="2"
          style="color: var(--primary)"></circle>
        <circle cx="12" cy="12" r="6" fill="var(--primary)" style="opacity: 0.9"></circle>
      </svg>
      <span class="xs:inline hidden">{title}</span>
      <span
        class="px-2 py-0.5 text-xs font-semibold sm:px-2.5 sm:py-1 sm:text-sm"
        style="background: var(--glow-primary); border: 1px solid var(--primary); color: var(--primary); border-radius: var(--radius-full)"
      >
        GT
      </span>
    </a>

    <!-- Navegación desktop -->
    <nav class="hidden items-center gap-2 md:flex">
      <a
        href={`${prefix}/`}
        class="border border-transparent px-3 py-2 transition-all duration-200"
        style="border-radius: var(--radius-md); &:hover { background: var(--card-hover); border-color: var(--border) }"
      >
        {t("nav.home")}
      </a>
      <a
        href={`${prefix}/indice`}
        class="border border-transparent px-3 py-2 transition-all duration-200"
        style="border-radius: var(--radius-md); &:hover { background: var(--card-hover); border-color: var(--border) }"
      >
        {t("nav.index")}
      </a>
      <a
        href={`${prefix}/buscar`}
        class="border border-transparent px-3 py-2 transition-all duration-200"
        style="border-radius: var(--radius-md); &:hover { background: var(--card-hover); border-color: var(--border) }"
      >
        {t("nav.search")}
      </a>
      <LanguageSwitcher />
      <button
        id="theme-toggle"
        class="inline-flex cursor-pointer items-center gap-2 px-2.5 py-2 transition-all duration-200"
        style="border: 1px solid var(--border); background: var(--glow-primary); border-radius: var(--radius-md); &:hover { background: var(--card-hover) }"
        type="button"
        aria-label="Cambiar tema"
      >
        <svg id="moon" class="block" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"
          ><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79Z"></path></svg
        >
        <svg
          id="sun"
          class="hidden"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          ><circle cx="12" cy="12" r="4"></circle><path
            d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"
          ></path></svg
        >
      </button>
    </nav>

    <!-- Controles móviles -->
    <div class="flex items-center gap-2 md:hidden">
      <button
        id="theme-toggle-mobile"
        class="inline-flex cursor-pointer items-center gap-2 px-2.5 py-2 transition-all duration-200"
        style="border: 1px solid var(--border); background: var(--glow-primary); border-radius: var(--radius-md); &:hover { background: var(--card-hover) }"
        type="button"
        aria-label="Cambiar tema"
      >
        <svg
          id="moon-mobile"
          class="block"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="currentColor"
          ><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79Z"></path></svg
        >
        <svg
          id="sun-mobile"
          class="hidden"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          ><circle cx="12" cy="12" r="4"></circle><path
            d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"
          ></path></svg
        >
      </button>
      <button
        id="menu-toggle"
        class="inline-flex cursor-pointer items-center px-2.5 py-2 transition-all duration-200"
        style="border: 1px solid var(--border); background: var(--background); border-radius: var(--radius-md); &:hover { background: var(--card-hover) }"
        type="button"
        aria-label="Abrir menú"
        aria-expanded="false"
      >
        <svg
          id="menu-icon"
          class="block"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          ><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"
          ></line><line x1="3" y1="18" x2="21" y2="18"></line></svg
        >
        <svg
          id="close-icon"
          class="hidden"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          ><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"
          ></line></svg
        >
      </button>
    </div>
  </div>

  <!-- Menú móvil -->
  <nav
    id="mobile-menu"
    class="mt-4 hidden flex-col gap-2 border-t pt-4 pb-2 md:hidden"
    style="border-color: var(--border)"
  >
    <a
      href={`${prefix}/`}
      class="border border-transparent px-4 py-2.5 text-center transition-all duration-200"
      style="border-radius: var(--radius-md); &:hover { background: var(--card-hover); border-color: var(--border) }"
    >
      {t("nav.home")}
    </a>
    <a
      href={`${prefix}/indice`}
      class="border border-transparent px-4 py-2.5 text-center transition-all duration-200"
      style="border-radius: var(--radius-md); &:hover { background: var(--card-hover); border-color: var(--border) }"
    >
      {t("nav.index")}
    </a>
    <a
      href={`${prefix}/buscar`}
      class="border border-transparent px-4 py-2.5 text-center transition-all duration-200"
      style="border-radius: var(--radius-md); &:hover { background: var(--card-hover); border-color: var(--border) }"
    >
      {t("nav.search")}
    </a>
  </nav>
</header>

<style>
  @media (min-width: 480px) {
    .xs\:inline {
      display: inline;
    }
  }
</style>
<script is:inline>
  const el = document.documentElement;
  const saved = localStorage.getItem("theme") || "dark";
  el.setAttribute("data-theme", saved);

  // Botones de tema
  const btn = document.getElementById("theme-toggle");
  const btnMobile = document.getElementById("theme-toggle-mobile");
  const m = document.getElementById("moon");
  const s = document.getElementById("sun");
  const mMobile = document.getElementById("moon-mobile");
  const sMobile = document.getElementById("sun-mobile");

  function updateIcons() {
    const t = el.getAttribute("data-theme");
    if (t === "light") {
      s?.classList.remove("hidden");
      m?.classList.add("hidden");
      sMobile?.classList.remove("hidden");
      mMobile?.classList.add("hidden");
    } else {
      s?.classList.add("hidden");
      m?.classList.remove("hidden");
      sMobile?.classList.add("hidden");
      mMobile?.classList.remove("hidden");
    }
  }

  updateIcons();

  function toggleTheme() {
    const next = el.getAttribute("data-theme") === "dark" ? "light" : "dark";
    el.setAttribute("data-theme", next);
    localStorage.setItem("theme", next);
    updateIcons();
  }

  btn?.addEventListener("click", toggleTheme);
  btnMobile?.addEventListener("click", toggleTheme);

  // Menú móvil
  const menuToggle = document.getElementById("menu-toggle");
  const mobileMenu = document.getElementById("mobile-menu");
  const menuIcon = document.getElementById("menu-icon");
  const closeIcon = document.getElementById("close-icon");

  menuToggle?.addEventListener("click", () => {
    const isOpen = mobileMenu?.classList.contains("flex");

    if (isOpen) {
      mobileMenu?.classList.remove("flex");
      mobileMenu?.classList.add("hidden");
      menuIcon?.classList.remove("hidden");
      menuIcon?.classList.add("block");
      closeIcon?.classList.remove("block");
      closeIcon?.classList.add("hidden");
      menuToggle?.setAttribute("aria-expanded", "false");
    } else {
      mobileMenu?.classList.remove("hidden");
      mobileMenu?.classList.add("flex");
      menuIcon?.classList.remove("block");
      menuIcon?.classList.add("hidden");
      closeIcon?.classList.remove("hidden");
      closeIcon?.classList.add("block");
      menuToggle?.setAttribute("aria-expanded", "true");
    }
  });

  // Cerrar menú al hacer clic en un enlace
  const mobileLinks = mobileMenu?.querySelectorAll("a");
  mobileLinks?.forEach((link) => {
    link.addEventListener("click", () => {
      mobileMenu?.classList.remove("flex");
      mobileMenu?.classList.add("hidden");
      menuIcon?.classList.remove("hidden");
      menuIcon?.classList.add("block");
      closeIcon?.classList.remove("block");
      closeIcon?.classList.add("hidden");
      menuToggle?.setAttribute("aria-expanded", "false");
    });
  });

  // Mantener el tema durante las transiciones
  document.addEventListener("astro:after-swap", () => {
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.documentElement.setAttribute("data-theme", savedTheme);
    updateIcons();
  });
</script>
