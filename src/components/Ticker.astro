---
import { slugify } from "../utils/slug.js";

const { words = [], lang = "es" }: { words?: string[]; lang?: string } = Astro.props;
const prefix = `/${lang}`;

function shuffle<T>(arr: T[]): T[] {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

const shuffled = shuffle(words);
const perRow = Math.ceil(shuffled.length / 3);
const baseRows: string[][] = [
  shuffled.slice(0, perRow),
  shuffled.slice(perRow, perRow * 2),
  shuffled.slice(perRow * 2, perRow * 3),
].map((r) => r.filter(Boolean));
---

<div class="ticker-container my-6 grid gap-3" data-prefix={prefix}>
  {
    baseRows.map((row, idx) => (
      <div class="ticker-row relative overflow-hidden backdrop-blur-sm">
        {/* Gradientes de fade en los bordes */}
        <div class="ticker-fade-left" />
        <div class="ticker-fade-right" />

        <div
          class={`ticker-content flex gap-6 px-5 py-3 whitespace-nowrap ${idx % 2 === 1 ? "animate-[scroll_28s_linear_infinite_reverse]" : "animate-[scroll_22s_linear_infinite]"}`}
          aria-hidden="true"
        >
          {row.map((w) => (
            <a
              class="ticker-word bg-card border-theme shadow-theme-sm text-theme inline-flex items-center gap-2 rounded-xl border px-4 py-2 text-sm font-medium transition-all duration-300 hover:-translate-y-1 hover:scale-105 active:scale-95"
              href={`${prefix}/palabras/${slugify(w)}`}
              tabindex="-1"
              aria-hidden="true"
            >
              <span
                class="ticker-dot h-2 w-2 animate-pulse rounded-xl"
                style="
                background: var(--primary);
                box-shadow: 0 0 8px var(--primary);
              "
              />
              <span class="ticker-text">{w}</span>
            </a>
          ))}
        </div>
      </div>
    ))
  }
</div>

<script>
  (function () {
    const container = document.querySelector(".ticker-container");
    if (!container) return;
    const prefix = container.getAttribute("data-prefix") || "";
    const rows = [...container.querySelectorAll(".ticker-content")];
    const words = [
      ...new Set(
        rows.flatMap((r) =>
          [...r.querySelectorAll(".ticker-text")].map((s) => s.textContent.trim())
        )
      ),
    ];
    function shuffle(a: any) {
      const arr = [...a];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    const shuffled = shuffle(words);
    const perRow = Math.ceil(shuffled.length / rows.length);
    let index = 0;
    rows.forEach((r, rowIdx) => {
      const slice = shuffled.slice(index, index + perRow);
      index += perRow;
      r.innerHTML = "";
      slice.forEach((w) => {
        const slug = w
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");
        const a = document.createElement("a");
        a.href = prefix + "/palabras/" + slug;
        a.className =
          "ticker-word bg-card border-theme shadow-theme-sm text-theme inline-flex items-center gap-2 rounded-xl border px-4 py-2 text-sm font-medium transition-all duration-300 hover:-translate-y-1 hover:scale-105 active:scale-95";
        a.tabIndex = -1;
        a.setAttribute("aria-hidden", "true");
        const dot = document.createElement("span");
        dot.className = "ticker-dot h-2 w-2 animate-pulse rounded-xl";
        dot.style.background = "var(--primary)";
        dot.style.boxShadow = "0 0 8px var(--primary)";
        const text = document.createElement("span");
        text.className = "ticker-text";
        text.textContent = w;
        a.appendChild(dot);
        a.appendChild(text);
        r.appendChild(a);
      });
      const original = [...r.children];
      original.forEach((n) => r.appendChild(n.cloneNode(true)));
      original.forEach((n) => r.appendChild(n.cloneNode(true)));
      const baseDuration = 22;
      const variance = 6;
      const speed = baseDuration + rowIdx * variance;
      (r as HTMLElement).style.animationDuration = speed + "s";
    });
  })();
</script>

<style>
  .ticker-container {
    position: relative;
  }

  .ticker-row {
    position: relative;
    min-height: 52px;
  }

  .ticker-row:hover .ticker-content {
    animation-play-state: paused;
  }

  .ticker-fade-left,
  .ticker-fade-right {
    position: absolute;
    top: 0;
    bottom: 0;
    width: clamp(40px, 8vw, 80px);
    z-index: 10;
    pointer-events: none;
  }

  .ticker-fade-left {
    left: 0;
    background: linear-gradient(to right, var(--background) 0%, transparent 100%);
  }

  .ticker-fade-right {
    right: 0;
    background: linear-gradient(to left, var(--background) 0%, transparent 100%);
  }

  .ticker-word {
    flex-shrink: 0;
    cursor: pointer;
    user-select: none;
    position: relative;
  }

  .ticker-word:hover {
    box-shadow:
      0 4px 12px var(--shadow-md),
      0 2px 4px var(--shadow-sm) !important;
    border-color: var(--primary) !important;
    background: var(--card-hover) !important;
  }

  .ticker-word:hover .ticker-text {
    color: var(--primary);
  }

  .ticker-word:hover .ticker-dot {
    animation: none;
    transform: scale(1.2);
  }

  .ticker-word:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 3px;
  }

  .ticker-content {
    display: flex;
    will-change: transform;
  }

  @keyframes scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-33.333%);
    }
  }

  /* Mejoras de rendimiento */
  @media (prefers-reduced-motion: reduce) {
    .ticker-content {
      animation: none !important;
    }

    .ticker-dot {
      animation: none !important;
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .ticker-container {
      gap: 0.625rem;
      margin-top: 1.25rem;
      margin-bottom: 1.25rem;
    }

    .ticker-row {
      min-height: 48px;
    }

    .ticker-content {
      gap: 1rem;
      padding: 0.625rem 1rem;
    }

    .ticker-word {
      padding: 0.5rem 0.875rem;
      font-size: 0.8125rem;
      gap: 0.5rem;
    }

    .ticker-fade-left,
    .ticker-fade-right {
      width: 40px;
    }
  }

  @media (max-width: 480px) {
    .ticker-word {
      padding: 0.4rem 0.75rem;
      font-size: 0.75rem;
    }

    .ticker-dot {
      width: 0.375rem;
      height: 0.375rem;
    }
  }
</style>
