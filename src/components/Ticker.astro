---
import { slugify } from "../utils/slug.js";

export interface Props {
  words?: string[];
  lang?: string;
  variant?: "default" | "vibrant";
}
const { words = [], lang = "es", variant = "default" }: Props = Astro.props;
const prefix = `/${lang}`;

function shuffle<T>(arr: T[]): T[] {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

const shuffled = shuffle(words);
const perRow = Math.ceil(shuffled.length / 3);
const baseRows: string[][] = [
  shuffled.slice(0, perRow),
  shuffled.slice(perRow, perRow * 2),
  shuffled.slice(perRow * 2, perRow * 3),
].map((r) => r.filter(Boolean));
---

<div
  class={`ticker-container my-6 grid gap-3 ${variant === "vibrant" ? "ticker--vibrant" : ""}`}
  data-prefix={prefix}
  data-variant={variant}
>
  {
    baseRows.map((row, idx) => (
      <div class="ticker-row relative overflow-hidden backdrop-blur-sm">
        {/* Gradientes de fade en los bordes */}
        <div class="ticker-fade-left" />
        <div class="ticker-fade-right" />
        <div
          class={`ticker-content flex gap-6 px-5 py-3 whitespace-nowrap ${idx % 2 === 1 ? "animate-[scroll_28s_linear_infinite_reverse]" : "animate-[scroll_22s_linear_infinite]"}`}
          aria-hidden="true"
        >
          {row.map((w) => (
            <a
              class="ticker-word bg-card border-theme shadow-theme-sm text-theme inline-flex items-center gap-2 rounded-xl border px-4 py-2 text-sm font-medium transition-all duration-300 hover:-translate-y-1 hover:scale-105 active:scale-95"
              href={`${prefix}/palabras/${slugify(w)}/`}
              tabindex="-1"
              aria-hidden="true"
            >
              <span
                class="ticker-dot h-2 w-2 animate-pulse rounded-xl"
                style="
                background: var(--primary);
                box-shadow: 0 0 8px var(--primary);
              "
              />
              <span class="ticker-text">{w}</span>
            </a>
          ))}
        </div>
      </div>
    ))
  }
</div>

<script>
  (function () {
    const container = document.querySelector(".ticker-container");
    if (!container) return;
    const prefix = container.getAttribute("data-prefix") || "";
    const rows = [...container.querySelectorAll(".ticker-content")];
    const words = [
      ...new Set(
        rows.flatMap((r) =>
          [...r.querySelectorAll(".ticker-text")].map((s) => s.textContent.trim())
        )
      ),
    ];
    function shuffle(a: any) {
      const arr = [...a];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    const shuffled = shuffle(words);
    const perRow = Math.ceil(shuffled.length / rows.length);
    let index = 0;
    rows.forEach((r, rowIdx) => {
      const slice = shuffled.slice(index, index + perRow);
      index += perRow;
      r.innerHTML = "";
      slice.forEach((w) => {
        const slug = w
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");
        const a = document.createElement("a");
        a.href = prefix + "/palabras/" + slug;
        a.className =
          "ticker-word bg-card border-theme shadow-theme-sm text-theme inline-flex items-center gap-2 rounded-xl border px-4 py-2 text-sm font-medium transition-all duration-300 hover:-translate-y-1 hover:scale-105 active:scale-95";
        a.tabIndex = -1;
        a.setAttribute("aria-hidden", "true");
        const dot = document.createElement("span");
        dot.className = "ticker-dot h-2 w-2 animate-pulse rounded-xl";
        dot.style.background = "var(--primary)";
        dot.style.boxShadow = "0 0 8px var(--primary)";
        const text = document.createElement("span");
        text.className = "ticker-text";
        text.textContent = w;
        a.appendChild(dot);
        a.appendChild(text);
        r.appendChild(a);
      });
      const original = [...r.children];
      original.forEach((n) => r.appendChild(n.cloneNode(true)));
      original.forEach((n) => r.appendChild(n.cloneNode(true)));
      const baseDuration = 22;
      const variance = 6;
      const speed = baseDuration + rowIdx * variance;
      (r as HTMLElement).style.animationDuration = speed + "s";
    });
  })();
</script>

<style>
  .ticker-container {
    position: relative;
  }

  .ticker--vibrant .ticker-row {
    border: 1px solid rgba(96, 165, 250, 0.18);
    background:
      radial-gradient(circle at 30% 20%, rgba(96, 165, 250, 0.2), transparent 60%),
      linear-gradient(135deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.88));
    border-radius: 20px;
    box-shadow:
      0 8px 28px -10px rgba(96, 165, 250, 0.25),
      0 2px 6px rgba(0, 0, 0, 0.5);
    overflow: hidden;
  }

  .ticker--vibrant .ticker-row:before {
    content: "";
    position: absolute;
    inset: 0;
    background: conic-gradient(
      from 0deg,
      rgba(96, 165, 250, 0.15),
      transparent 40%,
      rgba(96, 165, 250, 0.15) 70%,
      transparent 100%
    );
    mix-blend-mode: overlay;
    animation: sheenMove 9s linear infinite;
    pointer-events: none;
  }

  .ticker--vibrant .ticker-content {
    gap: 1.75rem;
    padding: 0.9rem 1.2rem;
  }

  .ticker--vibrant .ticker-word {
    background:
      linear-gradient(140deg, rgba(96, 165, 250, 0.18), rgba(96, 165, 250, 0.05)) padding-box,
      linear-gradient(
          140deg,
          rgba(96, 165, 250, 0.6),
          rgba(14, 165, 233, 0.45),
          rgba(96, 165, 250, 0.6)
        )
        border-box;
    border: 1px solid transparent;
    box-shadow:
      0 0 0 1px rgba(96, 165, 250, 0.25),
      0 3px 10px -2px rgba(96, 165, 250, 0.35),
      0 2px 4px rgba(0, 0, 0, 0.4);
    position: relative;
    isolation: isolate;
    transition:
      background 0.5s,
      transform 0.4s,
      box-shadow 0.4s;
  }

  .ticker--vibrant .ticker-word:before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    opacity: 0;
    background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.35), transparent 70%);
    mix-blend-mode: overlay;
    transition: opacity 0.5s;
  }

  .ticker--vibrant .ticker-word:hover:before {
    opacity: 1;
  }
  .ticker--vibrant .ticker-word:hover {
    transform: translateY(-6px) scale(1.08);
    box-shadow:
      0 10px 30px -8px rgba(96, 165, 250, 0.55),
      0 4px 12px rgba(0, 0, 0, 0.55);
  }
  .ticker--vibrant .ticker-word:active {
    transform: scale(0.96);
  }

  .ticker--vibrant .ticker-dot {
    background: radial-gradient(circle at 35% 35%, #fff 0%, #60a5fa 45%, #0ea5e9 85%);
    box-shadow:
      0 0 10px 2px rgba(96, 165, 250, 0.8),
      0 0 28px -4px rgba(14, 165, 233, 0.5);
    animation: pulseGlow 3.2s ease-in-out infinite;
  }

  .ticker--vibrant .ticker-word .ticker-text {
    background: linear-gradient(90deg, #60a5fa, #0ea5e9, #60a5fa);
    -webkit-background-clip: text;
    color: transparent;
    animation: hueShift 12s linear infinite;
  }
  .ticker--vibrant .ticker-word:hover .ticker-text {
    filter: brightness(1.15);
  }

  @keyframes hueShift {
    0% {
      filter: hue-rotate(0deg);
    }
    100% {
      filter: hue-rotate(360deg);
    }
  }
  @keyframes sheenMove {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
  @keyframes pulseGlow {
    0%,
    100% {
      transform: scale(1);
      box-shadow:
        0 0 10px 2px rgba(96, 165, 250, 0.75),
        0 0 24px -4px rgba(14, 165, 233, 0.4);
    }
    50% {
      transform: scale(1.25);
      box-shadow:
        0 0 16px 4px rgba(96, 165, 250, 0.95),
        0 0 36px -4px rgba(14, 165, 233, 0.6);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .ticker--vibrant .ticker-word:hover {
      transform: none;
    }
    .ticker--vibrant .ticker-word .ticker-text {
      animation: none;
    }
    .ticker--vibrant .ticker-dot {
      animation: none;
    }
    .ticker--vibrant .ticker-row:before {
      animation: none;
    }
  }
  /* ===== Light theme adjustments for vibrant variant (proper scope) ===== */
  html[data-theme="light"] .ticker--vibrant .ticker-row {
    background:
      radial-gradient(circle at 30% 20%, rgba(96, 165, 250, 0.4), rgba(248, 250, 252, 0.92) 60%),
      linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(241, 245, 249, 0.9));
    border: 1px solid rgba(73, 151, 208, 0.35);
    box-shadow:
      0 6px 22px -8px rgba(73, 151, 208, 0.38),
      0 2px 5px rgba(0, 0, 0, 0.08);
  }
  html[data-theme="light"] .ticker--vibrant .ticker-row:before {
    background: conic-gradient(
      from 0deg,
      rgba(96, 165, 250, 0.18),
      transparent 40%,
      rgba(96, 165, 250, 0.18) 70%,
      transparent 100%
    );
    mix-blend-mode: normal;
    opacity: 0.7;
  }
  html[data-theme="light"] .ticker--vibrant .ticker-word {
    background:
      linear-gradient(140deg, rgba(96, 165, 250, 0.25), rgba(96, 165, 250, 0.1)) padding-box,
      linear-gradient(
          140deg,
          rgba(96, 165, 250, 0.7),
          rgba(14, 165, 233, 0.55),
          rgba(96, 165, 250, 0.7)
        )
        border-box;
    box-shadow:
      0 0 0 1px rgba(96, 165, 250, 0.35),
      0 3px 10px -2px rgba(73, 151, 208, 0.4),
      0 2px 4px rgba(0, 0, 0, 0.08);
  }
  html[data-theme="light"] .ticker--vibrant .ticker-word:hover {
    box-shadow:
      0 10px 30px -10px rgba(73, 151, 208, 0.55),
      0 4px 12px rgba(0, 0, 0, 0.12);
  }
  html[data-theme="light"] .ticker--vibrant .ticker-dot {
    background: radial-gradient(circle at 35% 35%, #fff 0%, #60a5fa 45%, #0ea5e9 85%);
    box-shadow:
      0 0 10px 2px rgba(96, 165, 250, 0.7),
      0 0 22px -4px rgba(14, 165, 233, 0.45);
  }
  html[data-theme="light"] .ticker--vibrant .ticker-word .ticker-text {
    background: linear-gradient(90deg, #1e3a8a, #0ea5e9, #1e3a8a);
    -webkit-background-clip: text;
    color: transparent;
    text-shadow:
      0 1px 2px rgba(0, 0, 0, 0.08),
      0 0 8px rgba(96, 165, 250, 0.25);
  }
  html[data-theme="light"] .ticker--vibrant .ticker-word:hover .ticker-text {
    filter: brightness(1.1);
  }
  html[data-theme="light"] .ticker--vibrant .ticker-word:before {
    background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.55), transparent 70%);
  }
  html[data-theme="light"] .ticker--vibrant .ticker-word:focus-visible {
    outline: 2px solid rgba(73, 151, 208, 0.8);
  }

  .ticker-row {
    position: relative;
    min-height: 52px;
  }

  .ticker-row:hover .ticker-content {
    animation-play-state: paused;
  }

  .ticker-fade-left,
  .ticker-fade-right {
    position: absolute;
    top: 0;
    bottom: 0;
    width: clamp(40px, 8vw, 80px);
    z-index: 10;
    pointer-events: none;
  }

  .ticker-fade-left {
    left: 0;
    background: linear-gradient(to right, var(--background) 0%, transparent 100%);
  }

  .ticker-fade-right {
    right: 0;
    background: linear-gradient(to left, var(--background) 0%, transparent 100%);
  }

  .ticker-word {
    flex-shrink: 0;
    cursor: pointer;
    user-select: none;
    position: relative;
  }

  .ticker-word:hover {
    box-shadow:
      0 4px 12px var(--shadow-md),
      0 2px 4px var(--shadow-sm) !important;
    border-color: var(--primary) !important;
    background: var(--card-hover) !important;
  }

  .ticker-word:hover .ticker-text {
    color: var(--primary);
  }

  .ticker-word:hover .ticker-dot {
    animation: none;
    transform: scale(1.2);
  }

  .ticker-word:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 3px;
  }

  .ticker-content {
    display: flex;
    will-change: transform;
  }

  @keyframes scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-33.333%);
    }
  }

  /* Mejoras de rendimiento */
  @media (prefers-reduced-motion: reduce) {
    .ticker-content {
      animation: none !important;
    }

    .ticker-dot {
      animation: none !important;
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .ticker-container {
      gap: 0.625rem;
      margin-top: 1.25rem;
      margin-bottom: 1.25rem;
    }

    .ticker-row {
      min-height: 48px;
    }

    .ticker-content {
      gap: 1rem;
      padding: 0.625rem 1rem;
    }

    .ticker-word {
      padding: 0.5rem 0.875rem;
      font-size: 0.8125rem;
      gap: 0.5rem;
    }

    .ticker-fade-left,
    .ticker-fade-right {
      width: 40px;
    }
  }

  @media (max-width: 480px) {
    .ticker-word {
      padding: 0.4rem 0.75rem;
      font-size: 0.75rem;
    }

    .ticker-dot {
      width: 0.375rem;
      height: 0.375rem;
    }
  }
</style>
