---
import { getLangFromUrl, useTranslations } from "@/utils/i18n";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const prefix = lang === "en" ? "/en" : "/es";
---

<button
  id="menu-toggle"
  class="border-theme bg-background hover:bg-card-hover inline-flex cursor-pointer items-center rounded-md border px-2.5 py-2 transition-all"
  type="button"
  aria-label="Abrir menú"
  aria-expanded="false"
  data-umami-event="Mobile Menu Toggle"
>
  <svg
    id="menu-icon"
    class="block"
    width="20"
    height="20"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    ><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line
      x1="3"
      y1="18"
      x2="21"
      y2="18"></line></svg
  >
  <svg
    id="close-icon"
    class="hidden"
    width="20"
    height="20"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    ><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg
  >
</button>

<!-- Menú móvil desplegable -->
<nav
  id="mobile-menu"
  class="border-theme bg-card/95 absolute top-full right-0 left-0 z-20 mx-2 -mt-8 hidden flex-col gap-3 rounded-xl border px-3 pt-5 pb-4 shadow-2xl backdrop-blur-sm md:hidden"
  style="max-height: calc(100vh - 100px); overflow-y: auto;"
>
  <a
    href={`${prefix}/`}
    class="nav-link hover:bg-primary/15 active:bg-primary/25 rounded-lg px-4 py-3.5 text-center text-base font-bold transition-colors"
    data-umami-event="Nav Home"
    data-umami-event-device="mobile"
  >
    {t("nav.home")}
  </a>
  <a
    href={`${prefix}/indice/`}
    class="nav-link hover:bg-primary/15 active:bg-primary/25 rounded-lg px-4 py-3.5 text-center text-base font-bold transition-colors"
    data-umami-event="Nav Index"
    data-umami-event-device="mobile"
  >
    {t("nav.index")}
  </a>
  <a
    href={`${prefix}/buscar/`}
    class="nav-link hover:bg-primary/15 active:bg-primary/25 rounded-lg px-4 py-3.5 text-center text-base font-bold transition-colors"
    data-umami-event="Nav Search"
    data-umami-event-device="mobile"
  >
    {t("nav.search")}
  </a>
</nav>

<script is:inline>
  function setupMobileMenu() {
    const menuToggle = document.getElementById("menu-toggle");

    if (menuToggle) {
      const newMenuToggle = menuToggle.cloneNode(true);
      menuToggle.parentNode?.replaceChild(newMenuToggle, menuToggle);

      document.getElementById("menu-toggle")?.addEventListener("click", () => {
        const menu = document.getElementById("mobile-menu");
        const icon = document.getElementById("menu-icon");
        const close = document.getElementById("close-icon");
        const toggle = document.getElementById("menu-toggle");
        const isOpen = menu?.classList.contains("flex");

        if (isOpen) {
          menu?.classList.remove("flex");
          menu?.classList.add("hidden");
          icon?.classList.remove("hidden");
          icon?.classList.add("block");
          close?.classList.remove("block");
          close?.classList.add("hidden");
          toggle?.setAttribute("aria-expanded", "false");
        } else {
          menu?.classList.remove("hidden");
          menu?.classList.add("flex");
          icon?.classList.remove("block");
          icon?.classList.add("hidden");
          close?.classList.remove("hidden");
          close?.classList.add("block");
          toggle?.setAttribute("aria-expanded", "true");
        }
      });
    }

    // Cerrar menú al hacer clic en un enlace
    const mobileLinks = document.getElementById("mobile-menu")?.querySelectorAll("a");
    mobileLinks?.forEach((link) => {
      link.addEventListener("click", () => {
        const menu = document.getElementById("mobile-menu");
        const icon = document.getElementById("menu-icon");
        const close = document.getElementById("close-icon");
        const toggle = document.getElementById("menu-toggle");

        menu?.classList.remove("flex");
        menu?.classList.add("hidden");
        icon?.classList.remove("hidden");
        icon?.classList.add("block");
        close?.classList.remove("block");
        close?.classList.add("hidden");
        toggle?.setAttribute("aria-expanded", "false");
      });
    });
  }

  // Setup on initial load
  setupMobileMenu();

  // Re-setup after each page navigation
  document.addEventListener("astro:page-load", setupMobileMenu);
</script>
