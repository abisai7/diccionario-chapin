---
export const prerender = true;

import Base from "../../layouts/Base.astro";
import SearchBox from "../../components/SearchBox.astro";
import { getCollection } from "astro:content";
import { useTranslations } from "../../utils/i18n";
import { getCategoryColor } from "../../utils/categoryColors";
import BreadcrumbSchema from "../../components/schemas/BreadcrumbSchema.astro";
import SearchPageSchema from "../../components/schemas/SearchPageSchema.astro";

export async function getStaticPaths() {
  return [{ params: { lang: "es" } }, { params: { lang: "en" } }];
}

const { lang } = Astro.params;
const t = useTranslations(lang);

const collectionName = lang === "es" ? "words-es" : "words-en";
const allWords = await getCollection(collectionName);

// Hreflang URLs for multilingual SEO
const alternateUrls = {
  es: "/es/buscar/",
  en: "/en/buscar/",
  xDefault: "/es/buscar/",
};

const wordData = JSON.stringify(
  allWords.map((w) => ({
    slug: w.slug,
    word: w.data.word,
    meaning: w.data.meaning,
    category: w.data.category,
  }))
);

// Create a map of category colors for the client script
const categoryColorsData = JSON.stringify({
  sustantivo: getCategoryColor("sustantivo"),
  noun: getCategoryColor("noun"),
  verbo: getCategoryColor("verbo"),
  verb: getCategoryColor("verb"),
  adjetivo: getCategoryColor("adjetivo"),
  adjective: getCategoryColor("adjective"),
  adverbio: getCategoryColor("adverbio"),
  adverb: getCategoryColor("adverb"),
  expresion: getCategoryColor("expresion"),
  expression: getCategoryColor("expression"),
  interjección: getCategoryColor("interjección"),
  interjection: getCategoryColor("interjection"),
});

const siteUrl = Astro.site || "https://chapinismos.org";
---

<Base
  title={t("search.title") + " — " + t("schema.site.name")}
  description={t("search.description")}
  keywords={t("search.keywords")}
  lang={lang}
  alternateUrls={alternateUrls}
>
  <BreadcrumbSchema
    slot="schema"
    lang={lang}
    siteUrl={siteUrl}
    items={[{ name: t("nav.search"), url: `/${lang}/buscar/` }]}
  />
  <SearchPageSchema
    slot="schema"
    lang={lang}
    siteUrl={siteUrl}
    title={t("search.title")}
    description={t("search.description")}
    url={`/${lang}/buscar/`}
  />
  <div class="mx-auto max-w-[1100px] px-6">
    <div class="card-with-gradient shadow-theme-lg my-6 grid gap-3.5 backdrop-blur-sm">
      <h1 class="gradient-text mx-4 mt-4 text-[clamp(1.8rem,2.4vw,2.6rem)]">
        {t("search.title")}
      </h1>
      <p class="text-muted mx-4 text-base">
        {t("search.subtitle")}
      </p>
      <div class="mx-4 mb-4 grid grid-cols-1">
        <SearchBox placeholder={t("home.search.placeholder")} />
      </div>
    </div>

    <div id="searchResults" class="mt-8 pb-12"></div>
  </div>

  <script
    is:inline
    define:vars={{
      wordData,
      categoryColorsData,
      searchTranslations: JSON.stringify({
        noResults: t("search.noResults"),
        tryAnother: t("search.tryAnother"),
        results: t("search.results"),
        categories: {
          sustantivo: t("search.category.sustantivo"),
          verbo: t("search.category.verbo"),
          adjetivo: t("search.category.adjetivo"),
          adverbio: t("search.category.adverbio"),
          expresion: t("search.category.expresion"),
          interjección: t("search.category.interjección"),
          noun: t("search.category.noun"),
          verb: t("search.category.verb"),
          adjective: t("search.category.adjective"),
          adverb: t("search.category.adverb"),
          expression: t("search.category.expression"),
          interjection: t("search.category.interjection"),
        },
      }),
      lang,
    }}
  >
    const words = JSON.parse(wordData);
    const input = document.querySelector('input[type="search"]');
    const resultsContainer = document.getElementById("searchResults");

    const t = JSON.parse(searchTranslations);
    const categoryColors = JSON.parse(categoryColorsData);

    function normalizeText(text) {
      return text
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }

    function getCategoryColor(category) {
      return categoryColors[category] || "#1e40af";
    }

    function getCategoryLabel(category) {
      return t.categories[category] || category;
    }

    function renderResults(results) {
      if (results.length === 0) {
        resultsContainer.innerHTML = `
          <div class="text-center py-12 px-4 border border-theme rounded-lg bg-card">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" 
                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                 class="text-muted mx-auto mb-4">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <p class="text-theme text-lg font-semibold mb-2">
              ${t.noResults}
            </p>
            <p class="text-muted">
              ${t.tryAnother}
            </p>
          </div>
        `;
        return;
      }

      const prefix = lang === "es" ? "/es" : "/en";

      resultsContainer.innerHTML = `
        <p class="text-muted mb-4 text-sm">
          ${results.length} ${t.results}
        </p>
        <div class="grid grid-cols-[repeat(auto-fill,minmax(260px,1fr))] gap-3.5">
          ${results
            .map(
              (item) => `
            <a href="${prefix}/palabras/${item.slug}/" 
               class="block no-underline p-4 border border-theme rounded-lg bg-card shadow-theme-sm transition-all duration-200 hover:-translate-y-0.5 hover:shadow-theme-md"
               data-umami-event="Search Result Click"
               data-umami-event-word="${item.word}"
               data-umami-event-category="${item.category}">
              <div class="flex items-center justify-between mb-2">
                <h3 class="m-0 text-xl font-semibold text-theme">
                  ${item.word}
                </h3>
                <span class="inline-block py-0.5 px-2 rounded text-xs font-medium text-white" style="background-color: ${getCategoryColor(item.category)};">
                  ${getCategoryLabel(item.category)}
                </span>
              </div>
              <p class="m-0 text-secondary text-sm leading-relaxed">
                ${item.meaning}
              </p>
            </a>
          `
            )
            .join("")}
        </div>
      `;
    }

    function search(query) {
      if (!query.trim()) {
        resultsContainer.innerHTML = "";
        return;
      }

      const normalized = normalizeText(query);
      const results = words.filter((w) => {
        const word = normalizeText(w.word);
        const meaning = normalizeText(w.meaning);
        const category = normalizeText(w.category);
        return (
          word.includes(normalized) || meaning.includes(normalized) || category.includes(normalized)
        );
      });

      renderResults(results);
    }

    // Prevent form submission
    const form = document.querySelector("form");
    form?.addEventListener("submit", (e) => {
      e.preventDefault();
      if (input) {
        search(input.value);
      }
    });

    input?.addEventListener("input", (e) => {
      search(e.target.value);
    });

    // Search on page load if there's a query in the URL
    document.addEventListener("astro:page-load", () => {
      const params = new URLSearchParams(window.location.search);
      const query = params.get("q");
      if (query && input) {
        input.value = query;
        search(query);
      }
    });
  </script>
</Base>
