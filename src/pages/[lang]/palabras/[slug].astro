---
export const prerender = true;

import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";
import { useTranslations } from "../../../utils/i18n";
import { getCategoryColor } from "../../../utils/categoryColors";
import RelatedWordsSection from "../../../components/RelatedWordsSection.astro";

export async function getStaticPaths() {
  const esWords = await getCollection("words-es");
  const enWords = await getCollection("words-en");

  const esPaths = esWords.map((entry) => ({
    params: { lang: "es", slug: entry.slug },
    props: { entry },
  }));

  const enPaths = enWords.map((entry) => ({
    params: { lang: "en", slug: entry.slug },
    props: { entry },
  }));

  return [...esPaths, ...enPaths];
}

function getRandomWords(allWords: any[], currentSlug: string, count: number = 3) {
  const filtered = allWords.filter((w) => w.slug !== currentSlug);
  const shuffled = filtered.sort(() => Math.random() - 0.5);
  return shuffled.slice(0, count);
}

function getRandomWordsByCategory(
  allWords: any[],
  currentSlug: string,
  category: string,
  count: number = 3
) {
  const filtered = allWords.filter((w) => w.slug !== currentSlug && w.data.category === category);
  const shuffled = filtered.sort(() => Math.random() - 0.5);
  return shuffled.slice(0, count);
}

const { lang } = Astro.params;
const { entry } = Astro.props;
const { Content } = await entry.render();
const word = entry.data;

// Get related words
const collection =
  lang === "es" ? await getCollection("words-es") : await getCollection("words-en");
const relatedWords = getRandomWordsByCategory(collection, entry.slug, word.category, 3);
const otherWords = getRandomWords(collection, entry.slug, 3);

const t = useTranslations(lang);

// Hreflang URLs for multilingual SEO
const alternateUrls = {
  es: `/es/palabras/${entry.slug}/`,
  en: `/en/palabras/${entry.slug}/`,
  xDefault: `/es/palabras/${entry.slug}/`,
};

// SEO optimization
const description = `${word.word}: ${word.meaning} | ${word.category} | ${word.examples?.[0] ? `${t("word.example.label")}: "${word.examples[0]}"` : ""}${word.examples?.[1] ? ` | "${word.examples[1]}"` : ""}`;
const keywords = `${word.word}, ${t("word.slang.label")}, ${word.category || t("word.slang.label")}, ${word.synonyms?.join(", ") || ""}`;

const structuredData = {
  "@context": "https://schema.org",
  "@type": "DefinedTerm",
  name: word.word,
  description: word.meaning,
  inDefinedTermSet: t("word.type"),
  termCode: entry.slug,
};
---

<Base
  title={`${t("word.page.title").replace("{word}", word.word)}`}
  description={description}
  keywords={keywords}
  type="article"
  lang={lang}
  alternateUrls={alternateUrls}
>
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

  <section class="mx-auto max-w-[1100px] px-6">
    <button
      onclick="history.back()"
      class="back-btn mb-4 cursor-pointer px-4 py-2.5 font-semibold transition-all duration-200 active:scale-95"
      data-umami-event="Word Back Button Click"
      data-umami-event-word={word.word}
    >
      ‚Üê {t("word.back")}
    </button>

    <article class="article-card p-6 transition-all duration-200" transition:animate="slide">
      <div class="mb-4 flex items-start justify-between gap-4">
        <div class="flex-1">
          <h1
            class="m-0 mb-2 bg-linear-to-r bg-clip-text text-[clamp(2rem,5vw,3rem)] leading-tight font-bold text-transparent"
            style="background-image: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 50%, #9333ea 100%)"
          >
            {word.word}
          </h1>
          <div class="flex items-center gap-2 text-sm">
            <span class="text-muted italic">
              [ {t("word.slang.label")} ]
            </span>
            {
              word.category && (
                <span
                  class="rounded-full px-3 py-1 text-xs font-semibold text-white"
                  style={`background-color: ${getCategoryColor(word.category)}; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1)`}
                >
                  {word.category}
                </span>
              )
            }
          </div>
        </div>
        <button
          id="share-image-btn"
          class="badge-primary-gradient hover:shadow-theme-lg inline-flex shrink-0 cursor-pointer items-center gap-2 rounded-lg px-4 py-2.5 text-sm font-semibold text-white transition-all duration-200 hover:-translate-y-0.5 active:scale-95"
          aria-label={t("word.share")}
          data-umami-event="Word Share Image Button Click"
          data-umami-event-word={word.word}
          data-umami-event-lang={lang}
          data-word-data={JSON.stringify(word)}
          data-slug={entry.slug}
          data-lang={lang}
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
          </svg>
          <span class="hidden sm:inline">{t("word.share")}</span>
        </button>
      </div>

      <div class="border-theme mt-6 border-t pt-4">
        <h2 class="my-0 mb-3 flex items-center gap-2 text-lg font-semibold">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19H4v-3L16.5 3.5z"></path>
          </svg>
          {t("word.definition")}
        </h2>
        <div class="accent-box my-4 rounded-lg p-4 text-base leading-relaxed">
          {word.meaning}
        </div>
      </div>

      {
        word.examples && word.examples.length > 0 && (
          <div class="border-theme mt-6 border-t pt-4">
            <h2 class="my-0 mb-3 flex items-center gap-2 text-lg font-semibold">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="8" y1="6" x2="21" y2="6" />
                <line x1="8" y1="12" x2="21" y2="12" />
                <line x1="8" y1="18" x2="21" y2="18" />
                <line x1="3" y1="6" x2="3.01" y2="6" />
                <line x1="3" y1="12" x2="3.01" y2="12" />
                <line x1="3" y1="18" x2="3.01" y2="18" />
              </svg>
              {t("word.examples")}
            </h2>
            <ul class="mt-4 space-y-2 pl-5">
              {word.examples.map((ex) => (
                <li class="example-box my-2 p-3 text-sm leading-relaxed italic">"{ex}"</li>
              ))}
            </ul>
          </div>
        )
      }

      {
        Content && (
          <div class="prose border-theme mt-6 pt-4">
            <Content />
          </div>
        )
      }

      <RelatedWordsSection
        words={relatedWords}
        title={t("word.related")}
        icon="chat"
        lang={lang}
        titleLevel="h3"
      />

      <RelatedWordsSection
        words={otherWords}
        title={t("word.explore")}
        icon="pencil"
        lang={lang}
        titleLevel="h3"
      />
    </article>
  </section>

  <style>
    .prose {
      color: var(--prose-text);
      max-width: 65ch;
    }
    .prose :global(h2) {
      color: var(--prose-headings);
      font-weight: 700;
      margin-top: 2em;
      margin-bottom: 1em;
      line-height: 1.3;
    }
    .prose :global(h3) {
      color: var(--prose-headings);
      font-weight: 600;
      margin-top: 1.6em;
      margin-bottom: 0.6em;
      line-height: 1.4;
    }
    .prose :global(p) {
      margin-top: 1.25em;
      margin-bottom: 1.25em;
      line-height: 1.75;
    }
    .prose :global(ul),
    .prose :global(ol) {
      margin-top: 1.25em;
      margin-bottom: 1.25em;
      padding-left: 1.625em;
    }
    .prose :global(li) {
      margin-top: 0.5em;
      margin-bottom: 0.5em;
    }
    .prose :global(strong) {
      color: var(--prose-bold);
      font-weight: 600;
    }
    .prose :global(a) {
      color: var(--prose-links);
      text-decoration: underline;
      font-weight: 500;
    }
    .prose :global(code) {
      color: var(--prose-code);
      font-weight: 600;
      font-size: 0.875em;
    }
    .prose :global(pre) {
      background-color: var(--prose-pre-bg);
      overflow-x: auto;
      font-size: 0.875em;
      line-height: 1.7;
      margin-top: 1.7em;
      margin-bottom: 1.7em;
      border-radius: 0.375rem;
      padding: 0.8em 1em;
    }
    .prose :global(blockquote) {
      font-style: italic;
      color: var(--prose-quotes);
      border-left: 0.25rem solid var(--border);
      padding-left: 1em;
      margin-top: 1.6em;
      margin-bottom: 1.6em;
    }
  </style>

  <script>
    import { setupShareImage } from "../../../utils/shareImage";

    document.addEventListener("astro:page-load", () => {
      const button = document.getElementById("share-image-btn");
      if (!button) return;

      const wordData = button.dataset.wordData ? JSON.parse(button.dataset.wordData) : null;
      const slug = button.dataset.slug;
      const lang = button.dataset.lang;

      if (wordData && slug && lang) {
        setupShareImage({
          buttonId: "share-image-btn",
          word: wordData,
          slug: slug,
          lang: lang,
        });
      }
    });
  </script>
</Base>
