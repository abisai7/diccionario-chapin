---
import Base from "../../layouts/Base.astro";
import { getCollection } from "astro:content";

export const prerender = true;

export async function getStaticPaths() {
  const allWords = await getCollection("words");
  return allWords.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const word = entry.data;

// SEO optimization
const description = `${word.word}: ${word.meaning} ${word.examples?.[0] ? `Ejemplo: "${word.examples[0]}"` : ""}`;
const keywords = `${word.word}, chapinismo, guatemaltequismo, ${word.category || "palabra chapina"}, jerga guatemalteca, ${word.synonyms?.join(", ") || ""}`;
const structuredData = {
  "@context": "https://schema.org",
  "@type": "DefinedTerm",
  name: word.word,
  description: word.meaning,
  inDefinedTermSet: "Diccionario Chapín",
  termCode: entry.slug,
};
---

<Base
  title={`${word.word} — Diccionario Chapín`}
  description={description}
  keywords={keywords}
  type="article"
>
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

  <section class="mx-auto max-w-[1100px] px-6">
    <div class="flex items-center justify-between gap-3">
      <button
        onclick="history.back()"
        class="cursor-pointer px-4 py-2.5 font-semibold transition-all duration-200 active:scale-95"
        style="background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: var(--radius-md); box-shadow: 0 1px 2px var(--shadow-sm); &:hover { background: var(--card-hover) }"
      >
        ← Volver
      </button>
      <button
        id="share-image-btn"
        class="inline-flex cursor-pointer items-center gap-2 px-4 py-2.5 font-semibold transition-all duration-200 active:scale-95"
        style="background: var(--primary); color: white; border: 1px solid var(--primary); border-radius: var(--radius-md); box-shadow: 0 1px 2px var(--shadow-sm); &:hover { opacity: 0.9 }"
      >
        <svg
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
          <polyline points="16 6 12 2 8 6"></polyline>
          <line x1="12" y1="2" x2="12" y2="15"></line>
        </svg>
        Compartir imagen
      </button>
    </div>
    <article
      class="mt-3.5 p-6 transition-all duration-200"
      style="background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-xl); box-shadow: 0 2px 8px var(--shadow-md)"
      transition:animate="slide"
    >
      <h1 class="m-0 mb-1.5 text-[2rem] tracking-[0.3px]" style="color: var(--text)">
        {word.word}
      </h1>
      <div class="mb-3 flex items-center gap-2 text-sm">
        <span class="italic" style="color: var(--muted)">[ chapinismo ]</span>
        {
          word.category && (
            <span
              class="rounded-full px-3 py-1 text-xs font-medium"
              style="background: var(--glow-primary); color: var(--primary); border: 1px solid var(--primary)"
            >
              {word.category}
            </span>
          )
        }
      </div>
      <div class="my-3 text-base leading-relaxed" style="color: var(--text-secondary)">
        {word.meaning}
      </div>

      <div class="mt-6 pt-4" style="border-top: 1px solid var(--border)">
        <h3 class="my-0 mb-3 flex items-center gap-2 text-lg font-semibold">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M3 3v18h18"></path>
            <path d="M18 17V9"></path>
            <path d="M13 17V5"></path>
            <path d="M8 17v-3"></path>
          </svg>
          Ejemplos
        </h3>
        <ul class="mt-4 space-y-2 pl-5">
          {
            word.examples?.map((ex) => (
              <li
                class="my-2 p-3 text-sm leading-relaxed italic"
                style="color: var(--muted); background: var(--glow-primary); border-left: 2px solid var(--primary); border-radius: var(--radius-md)"
              >
                "{ex}"
              </li>
            ))
          }
        </ul>
      </div>

      {
        Content && (
          <div class="prose mt-6 pt-4" style="border-top: 1px solid var(--border)">
            <Content />
          </div>
        )
      }
    </article>
  </section>

  <script define:vars={{ word, slug: entry.slug }}>
    document.getElementById("share-image-btn")?.addEventListener("click", async () => {
      await document.fonts.ready;

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      canvas.width = 630;
      canvas.height = 630;

      // Gradient background
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, "#1e293b");
      gradient.addColorStop(1, "#0f172a");
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Decorative rounded border
      ctx.strokeStyle = "#3b82f6";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.roundRect(20, 20, canvas.width - 40, canvas.height - 40, 20);
      ctx.stroke();

      // Logo/Título del diccionario
      ctx.fillStyle = "#60a5fa";
      ctx.font = "bold 32px 'Baloo 2 Variable', system-ui, sans-serif";
      ctx.fillText("Diccionario Chapín", 60, 80);

      // Palabra principal
      ctx.fillStyle = "#ffffff";
      ctx.font = "bold 72px 'Alice', 'Baloo 2 Variable', system-ui, sans-serif";
      const wordText = word.word;
      ctx.fillText(wordText, 60, 180);

      // Categoría con bordes redondeados
      if (word.category) {
        ctx.fillStyle = "#3b82f6";
        ctx.beginPath();
        ctx.roundRect(60, 200, 150, 35, 8);
        ctx.fill();
        ctx.fillStyle = "#ffffff";
        ctx.font = "600 16px 'Baloo 2 Variable', system-ui, sans-serif";
        ctx.fillText(word.category.toUpperCase(), 75, 223);
      }

      // Significado
      ctx.fillStyle = "#cbd5e1";
      ctx.font = "28px 'Baloo 2 Variable', system-ui, sans-serif";
      const meaning = word.meaning;

      // Dividir el texto en líneas para que quepa
      const maxWidth = canvas.width - 120;
      const words_array = meaning.split(" ");
      let line = "";
      let y = 280;
      const lineHeight = 40;

      for (let n = 0; n < words_array.length; n++) {
        const testLine = line + words_array[n] + " ";
        const metrics = ctx.measureText(testLine);
        if (metrics.width > maxWidth && n > 0) {
          ctx.fillText(line, 60, y);
          line = words_array[n] + " ";
          y += lineHeight;
          if (y > 420) break; // Limitar líneas
        } else {
          line = testLine;
        }
      }
      ctx.fillText(line, 60, y);

      // Ejemplo (si hay)
      if (word.examples && word.examples.length > 0) {
        ctx.fillStyle = "#94a3b8";
        ctx.font = "italic 22px 'Baloo 2 Variable', system-ui, sans-serif";
        const example = word.examples[0];
        const maxExampleY = 480;

        if (y + lineHeight + 40 < maxExampleY) {
          const exampleY = Math.min(y + lineHeight + 60, maxExampleY);
          ctx.fillText(
            `"${example.substring(0, 80)}${example.length > 80 ? "..." : ""}"`,
            60,
            exampleY
          );
        }
      }

      // Footer
      ctx.fillStyle = "#475569";
      ctx.font = "18px 'Baloo 2 Variable', system-ui, sans-serif";
      ctx.fillText("diccionariochapin.com", 60, canvas.height - 40);

      // Sinónimos (si hay)
      if (word.synonyms && word.synonyms.length > 0) {
        ctx.fillStyle = "#64748b";
        ctx.font = "16px 'Baloo 2 Variable', system-ui, sans-serif";
        const synonymsText = `Sinónimos: ${word.synonyms.slice(0, 3).join(", ")}`;
        ctx.fillText(synonymsText, 60, canvas.height - 70);
      }

      // Convert canvas to blob
      canvas.toBlob(async (blob) => {
        const fileName = `${slug}-diccionario-chapin.png`;

        // Try to use Web Share API if available
        if (
          navigator.share &&
          navigator.canShare({ files: [new File([blob], fileName, { type: "image/png" })] })
        ) {
          try {
            const file = new File([blob], fileName, { type: "image/png" });
            await navigator.share({
              files: [file],
              title: `${word.word} - Diccionario Chapín`,
              text: word.meaning,
            });
          } catch (err) {
            if (err.name !== "AbortError") {
              // If sharing fails, fallback to download
              downloadImage(blob, fileName);
            }
          }
        } else {
          // Fallback: download the image
          downloadImage(blob, fileName);
        }
      });
    });

    function downloadImage(blob, fileName) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</Base>
